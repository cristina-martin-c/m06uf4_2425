<!doctype html>
<html>
<head>
	<title>Pengti</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.87.0/phaser.min.js"></script>
	
	<script>

let player_num = 0;

let ws = new WebSocket('ws://10.40.2.116:7777');
ws.onmessage = function (msg) {
	console.log(msg.data);

	let data = JSON.parse(msg.data);

	if(data.player_num != null){
		player_num = data.player_num;
		console.log("Somos el jugador "+player_num);
	}
	else if (data.y != null){
		if (player_num == 1){
			player2.y = data.y;
		}
		else if (player_num == 2){
			player1.y = data.y;
		}
	}
	else if (data.by != null){
		ball.x = data.bx;
		ball.y = data.by;
	}
	else if (data.s1 != null){
		score1 = data.s1;
		text1.setText(score1);
		
		score2 = data.s2;
		text2.setText(score2);
	}
	//else if...
};

let win_w=800, win_h=450;

let config = {
    type: Phaser.AUTO,
    width: win_w,
    height: win_h,
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

let game = new Phaser.Game(config);
let player1, player2;
let player1_x=32, player1_y=225;
let player2_x=768, player2_y=225;

let players_w=16, players_h=96;

let ball;
let ball_x_init=400, ball_y_init=225, ball_w=16, ball_h=16;
let ball_x=ball_x_init, ball_y=ball_y_init;


let ball_x_dir=1, ball_y_dir=1;

let text1, text2;
let points1 = 0, points2 = 0;

function preload ()
{
}

function create ()
{
	player1 = this.add.rectangle(player1_x, player1_y, players_w, players_h, 0xffffff);
	player2 = this.add.rectangle(player2_x, player2_y, players_w, players_h, 0xffffff);
	ball = this.add.rectangle(ball_x, ball_y, ball_w, ball_h, 0xffff00);

	this.cursors = this.input.keyboard.createCursorKeys();
	
	text1 = this.add.text(player1_x,player1_x,points1,{
		font:"40px Arial"
		});
	text2 = this.add.text(player2_x - 50, player1_x, points2,{
		font:"40px Arial"
		});	
}

function ball_reset()
{
	ball.x = ball_x_init;
	ball.y = ball_y_init;

	ball_x_dir = -ball_x_dir;
}

function send_scores()
{
	//Enviando el score
	let scores = {
		s1: points1, 
		s2: points2
	};
	ws.send( JSON.stringify(scores) );
}

function update ()
{
	if(player_num == 0)
		return;

	//Movimiento pelota
	if(player_num == 1){
		ball.x += ball_x_dir;
		ball.y += ball_y_dir;

		if(ball.x > win_w){
			points1 += 1;
			text1.setText(points1);
			send_scores()
			
			ball_reset()
		}
		if (ball.x < 0){
			points2++;
			text2.setText(points2);

			send_scores()
			ball_reset()
		}

		if(ball.y > win_h || ball.y < 0)
	    	ball_y_dir = -ball_y_dir;
	
		let ball_pos = {
			bx: ball.x,
			by: ball.y
		};
	ws.send( JSON.stringify(ball_pos) );

		
	}
	//Movimiento Player 1 y 2
	if (this.cursors.up.isDown){
		if (player_num == 1)
			player1.y -= 1;
		else if (player_num == 2)
			player2.y -= 1;
	}
	else if (this.cursors.down.isDown){
		if (player_num == 1)
			player1.y += 1;
		else if (player_num == 2)
			player2.y += 1;
	}
	/*if (this.cursors.left.isDown){
		if (player_num == 1)
			player1.x -= 1;
		else if (player_num == 2)
			player2.x -= 1;
	}
	else if (this.cursors.right.isDown){
		if (player_num == 1)
			player1.x += 1;
		else if (player_num == 2)
			player2.x += 1;
	}*/
	
	let player_pos = {};

	if (player_num == 1)
		player_pos.y = player1.y
	else if (player_num == 2)
		player_pos.y = player2.y
	
	ws.send( JSON.stringify(player_pos) );

}	
	</script>
</head>
<body>
</body>
</html>
